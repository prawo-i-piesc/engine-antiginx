name: Vuln Verification
run-name: >-
    ${{ 
        github.event_name == 'pull_request' 
        && format('Vulnerability Verification for CI: PR #{0} -> {1}', github.event.number, github.event.pull_request.title)
    }}

on:
    pull_request:
        types: [opened, synchronize, reopened]

permissions:
    contents: read

concurrency:
    group: ${{ github.workflow }}-pr-${{ github.event.pull_request.number }}
    cancel-in-progress: true

jobs:
    vuln-ci-test:
        name: Testing
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
        - name: ðŸ“¥ Git -- Checkout repository
          uses: actions/checkout@v6

        - name: ðŸ“˜ Go -- Set up
          uses: actions/setup-go@v6
          with:
            go-version-file: 'go.mod'
            cache: true

        - name: ðŸ³ Docker -- Set up
          uses: docker/setup-buildx-action@v3

        - name: ðŸ“¦ Go -- Install dependencies
          run: |
            go install golang.org/x/vuln/cmd/govulncheck@latest

        - name: ðŸ³ Docker -- Build Image for Scanning
          uses: docker/build-push-action@v6
          with:
            context: .
            push: false
            load: true
            tags: ${{ github.repository }}:ci-test
            cache-from: type=gha
            cache-to: type=gha,mode=max

        - name: ðŸ§ª Go -- Test Vulnerability -> Modules
          run: |
            echo "âš™ï¸ Running govulncheck on Go modules:"
            if govulncheck ./...; then
                echo ""
                echo "âœ… No vulnerabilities found in Go modules."
            else
                echo ""
                echo "âŒ Vulnerabilities found in Go modules."
                exit 1
            fi

        - name: ðŸ§ª Trivy -- Test Vulnerability -> File System
          uses: aquasecurity/trivy-action@master
          with:
            scan-type: fs
            ignore-unfixed: true
            format: table
            severity: CRITICAL,HIGH,MEDIUM
            exit-code: '1'

        - name: ðŸ§ª Trivy -- Test Vulnerability -> Container Image
          uses: aquasecurity/trivy-action@master
          with:
            scan-type: image
            image-ref: ${{ github.repository }}:ci-test
            ignore-unfixed: true
            vuln-type: os,library
            format: table
            severity: CRITICAL,HIGH,MEDIUM
            exit-code: '1'